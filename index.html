
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte interactive AHPV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f7fa; }
    header { background: #005d8f; color: white; padding: 1rem; text-align: center; }
    #filters { padding: 10px; background: white; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #filters select { padding: 5px; }
    #map { height: 90vh; }
  </style>
</head>
<body>
  <header>
    <h1>üìç Carte interactive des publications AHPV</h1>
  </header>

  <div id="filters">
    <label>Ville : <select id="filter-ville"><option value="">Toutes</option></select></label>
    <label>Th√®me : <select id="filter-theme"><option value="">Tous</option></select></label>
    <label>Auteur : <select id="filter-auteur"><option value="">Tous</option></select></label>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([45.074, 5.772], 10);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {{
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }}).addTo(map);

    const dataUrl = 'data_for_map_cleaned.csv';
    let markers = [];

    function filtrerDonnees(ville, theme, auteur, data) {
      return data.filter(item =>
        (!ville || item["Ville(s)"] === ville) &&
        (!theme || (item["Theme(s)"] || '').includes(theme)) &&
        (!auteur || (item["Auteur(s)"] || '').includes(auteur))
      );
    }

    function mettreAJourCarte(data, ville, theme, auteur) {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      const filtres = filtrerDonnees(ville, theme, auteur, data);

      filtres.forEach(item => {
        const lieu = item["Ville(s)"];
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${lieu},France`)
          .then(response => response.json())
          .then(json => {
            if (json && json.length > 0) {
              const coords = [parseFloat(json[0].lat), parseFloat(json[0].lon)];
              const popup = `<b>${item["Titre"]}</b><br>${item["Auteur(s)"]}<br><i>${item["Theme(s)"]}</i>`;
              const marker = L.marker(coords).addTo(map).bindPopup(popup);
              markers.push(marker);
            }
          });
      });
    }

    Papa.parse(dataUrl, {{
      header: true,
      download: true,
      complete: function(results) {{
        const data = results.data;

        const villes = [...new Set(data.map(row => row["Ville(s)"]).filter(Boolean))].sort();
        const themes = [...new Set(data.flatMap(row => (row["Theme(s)"] || '').split(',').map(s => s.trim()))).filter(Boolean)].sort();
        const auteurs = [...new Set(data.flatMap(row => (row["Auteur(s)"] || '').split(',').map(s => s.trim()))).filter(Boolean)].sort();

        villes.forEach(v => document.getElementById('filter-ville').innerHTML += `<option value="${v}">${v}</option>`);
        themes.forEach(t => document.getElementById('filter-theme').innerHTML += `<option value="${t}">${t}</option>`);
        auteurs.forEach(a => document.getElementById('filter-auteur').innerHTML += `<option value="${a}">${a}</option>`);

        document.querySelectorAll('#filters select').forEach(select => {{
          select.addEventListener('change', () => {{
            const ville = document.getElementById('filter-ville').value;
            const theme = document.getElementById('filter-theme').value;
            const auteur = document.getElementById('filter-auteur').value;
            mettreAJourCarte(data, ville, theme, auteur);
          }});
        }});

        mettreAJourCarte(data, "", "", "");
      }}
    }});
  </script>
</body>
</html>
